<!DOCTYPE HTML>
<html>

<head>
    <title>DMX Web Server</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="data:,">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="topnav">
        <h1>DMX Web Server</h1>
    </div>

    <div class="content">
        <div class="card">
            <h2>Output - GPIO 2</h2>
            <p class="state">state: <span id="state">%STATE%</span></p>
            <p><button id="button" class="button">Toggle</button></p>
        </div>

        <!-- Sliders -->
        <div class="card">
            <h2>DMX channel control 1-6</h2>

            <label for="s1">Channel 1: <span id="val1">0</span></label>
            <input type="range" min="0" max="255" value="0" class="slider" id="s1">

            <label for="s2">Channel 2: <span id="val2">0</span></label>
            <input type="range" min="0" max="255" value="0" class="slider" id="s2">

            <label for="s3">Channel 3: <span id="val3">0</span></label>
            <input type="range" min="0" max="255" value="0" class="slider" id="s3">

            <label for="s4">Channel 4: <span id="val4">0</span></label>
            <input type="range" min="0" max="255" value="0" class="slider" id="s4">

            <label for="s5">Channel 5: <span id="val5">0</span></label>
            <input type="range" min="0" max="255" value="0" class="slider" id="s5">

            <label for="s6">Channel 6: <span id="val6">0</span></label>
            <input type="range" min="0" max="255" value="0" class="slider" id="s6">
        </div>

    </div>

    <script>
        var gateway = `ws://${window.location.hostname}/ws`;
        var websocket;

        function initWebSocket() {
            console.log('Trying to open a WebSocket connection...');
            websocket = new WebSocket(gateway);
            websocket.onopen = onOpen;
            websocket.onclose = onClose;
            websocket.onmessage = onMessage;
        }

        function onOpen(event) {
            console.log('Connection opened');
        }

        function onClose(event) {
            console.log('Connection closed');
            setTimeout(initWebSocket, 2000);
        }

        function onMessage(event) {
            var state;
            if (event.data == "1") {
                state = "ON";
            }
            else {
                state = "OFF";
            }
            document.getElementById('state').innerHTML = state;
        }

        window.addEventListener('load', onLoad);

        function onLoad(event) {
            initWebSocket();
            initButton();
            initSliders();
        }

        function initButton() {
            document.getElementById('button').addEventListener('click', toggle);
        }

        function toggle() {
            websocket.send('toggle');
        }

        function initSliders() {
            for (let i = 1; i <= 6; i++) {
                let slider = document.getElementById('s' + i);
                let output = document.getElementById('val' + i);

                // set initial value
                output.innerHTML = slider.value;

                // update when moved
                slider.addEventListener('input', function () {
                    output.innerHTML = this.value;
                    sendSlider({ target: this });
                });
            }
        }


        function sendSlider(event) {
            let id = event.target.id.substring(1); // get number from s1 â†’ 1
            let value = event.target.value;
            websocket.send(id + ":" + value);
            console.log("Sent -> " + id + ":" + value);
        }
    </script>
</body>

</html>
