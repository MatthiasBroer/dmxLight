<!DOCTYPE HTML>
<html>

<head>
    <title>DMX Web Server</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="data:,">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="topnav">
        <h1>DMX Web Server</h1>
    </div>

    <div class="content">
        <div class="card">
            <h2>Output - GPIO 2</h2>
            <p class="state">state: <span id="state">%STATE%</span></p>
            <p><button id="button" class="button">Toggle</button></p>
        </div>

        <!-- Color Wave Control -->
        <div class="card">
            <h2>Color Wave</h2>

            <button id="waveButton" class="button">Start Wave</button>

            <label for="waveSpeed">Wave Speed: <span id="waveSpeedVal">100</span> ms</label>
            <input type="range" min="10" max="5000" value="100" class="slider" id="waveSpeed">
        </div>

        <!-- Chaser Control -->
        <div class="card">
            <h2>Channel Chaser</h2>

            <button id="chaserButton" class="button">Start Chaser</button>

            <label for="chaserSpeed">Chaser Speed: <span id="chaserSpeedVal">100</span> ms</label>
            <input type="range" min="10" max="5000" value="100" class="slider" id="chaserSpeed">
        </div>

        <!-- Sliders -->
        <div class="card">
            <h2>DMX channel control 1-16</h2>

            <label for="s1">Channel 1: <span id="val1">0</span></label>
            <input type="range" min="0" max="255" value="0" class="slider" id="s1">

            <label for="s2">Channel 2: <span id="val2">0</span></label>
            <input type="range" min="0" max="255" value="0" class="slider" id="s2">

            <label for="s3">Channel 3: <span id="val3">0</span></label>
            <input type="range" min="0" max="255" value="0" class="slider" id="s3">

            <label for="s4">Channel 4: <span id="val4">0</span></label>
            <input type="range" min="0" max="255" value="0" class="slider" id="s4">

            <label for="s5">Channel 5: <span id="val5">0</span></label>
            <input type="range" min="0" max="255" value="0" class="slider" id="s5">

            <label for="s6">Channel 6: <span id="val6">0</span></label>
            <input type="range" min="0" max="255" value="0" class="slider" id="s6">

            <label for="s7">Channel 7: <span id="val7">0</span></label>
            <input type="range" min="0" max="255" value="0" class="slider" id="s7">
            
            <label for="s8">Channel 8: <span id="val8">0</span></label>
            <input type="range" min="0" max="255" value="0" class="slider" id="s8">

            <label for="s9">Channel 9: <span id="val9">0</span></label>
            <input type="range" min="0" max="255" value="0" class="slider" id="s9">

            <label for="s10">Channel 10: <span id="val10">0</span></label>
            <input type="range" min="0" max="255" value="0" class="slider" id="s10">

            <label for="s11">Channel 11: <span id="val11">0</span></label>
            <input type="range" min="0" max="255" value="0" class="slider" id="s11">

            <label for="s12">Channel 12: <span id="val12">0</span></label>
            <input type="range" min="0" max="255" value="0" class="slider" id="s12">

            <label for="s13">Channel 13: <span id="val13">0</span></label>
            <input type="range" min="0" max="255" value="0" class="slider" id="s13">

            <label for="s14">Channel 14: <span id="val14">0</span></label>
            <input type="range" min="0" max="255" value="0" class="slider" id="s14">

            <label for="s15">Channel 15: <span id="val15">0</span></label>
            <input type="range" min="0" max="255" value="0" class="slider" id="s15">

            <label for="s16">Channel 16: <span id="val16">0</span></label>
            <input type="range" min="0" max="255" value="0" class="slider" id="s16">
        </div>

    </div>

    <script>
        var gateway = `ws://${window.location.hostname}/ws`;
        var websocket;

        function initWebSocket() {
            console.log('Trying to open a WebSocket connection...');
            websocket = new WebSocket(gateway);
            websocket.onopen = onOpen;
            websocket.onclose = onClose;
            websocket.onmessage = onMessage;
        }

        function onOpen(event) {
            console.log('Connection opened');
        }

        function onClose(event) {
            console.log('Connection closed');
            setTimeout(initWebSocket, 2000);
        }

        function onMessage(event) {
            const msg = event.data;

            // simple on/off state
            if (msg == "1" || msg == "0") {
                document.getElementById('state').innerHTML = (msg == "1" ? "ON" : "OFF");
                return;
            }
        }

        window.addEventListener('load', onLoad);

        function onLoad(event) {
            initWebSocket();
            initButton();
            initSliders();
        }

        function initButton() {
            document.getElementById('button').addEventListener('click', toggle);
        }

        function toggle() {
            websocket.send('toggle');
        }

        function initSliders() {
            for (let i = 1; i <= 16; i++) {
                let slider = document.getElementById('s' + i);
                let output = document.getElementById('val' + i);

                // set initial value
                output.innerHTML = slider.value;

                // update when moved
                slider.addEventListener('input', function () {
                    output.innerHTML = this.value;
                    sendSlider({ target: this });
                });
            }
        }


        function sendSlider(event) {
            let id = event.target.id.substring(1); // get number from s1 â†’ 1
            let value = event.target.value;
            websocket.send(id + ":" + value);
            console.log("Sent -> " + id + ":" + value);
        }

        function initWaveControls() {
            const waveButton = document.getElementById('waveButton');
            const waveSpeedSlider = document.getElementById('waveSpeed');
            const waveSpeedVal = document.getElementById('waveSpeedVal');

            waveButton.addEventListener('click', function() {
                websocket.send('wave:toggle'); // toggle wave on/off
            });

            waveSpeedSlider.addEventListener('input', function() {
                waveSpeedVal.innerHTML = this.value;
                websocket.send('wave:speed:' + this.value); // send new speed
            });
        }

        window.addEventListener('load', function() {
            initWaveControls();
        });

        function initChaserControls() {
            const chaserButton = document.getElementById('chaserButton');
            const chaserSpeedSlider = document.getElementById('chaserSpeed');
            const chaserSpeedVal = document.getElementById('chaserSpeedVal');

            chaserButton.addEventListener('click', function() {
                websocket.send('chaser:toggle'); // toggle chaser
            });

            chaserSpeedSlider.addEventListener('input', function() {
                chaserSpeedVal.innerHTML = this.value;
                websocket.send('chaser:speed:' + this.value); // set speed
            });
        }

        window.addEventListener('load', function() {
            initChaserControls();
        });
    </script>
</body>

</html>
