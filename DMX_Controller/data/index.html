<!DOCTYPE HTML>
<html>

<head>
    <title>DMX Web Server</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="data:,">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="topnav">
        <h1>DMX Web Server</h1>
        <!-- go back to setup file -->
        <a href="/setup.html"><button class="button">Settings</button></a>
    </div>

    <div class="content">
        <!-- Color Wave Control -->
        <div class="card">
            <h2>Color Wave</h2>

            <button id="waveButton" class="button">Start Wave</button>

            <label for="waveSpeed">Wave Speed: <span id="waveSpeedVal">100</span> ms</label>
            <input type="range" min="10" max="5000" value="100" class="slider" id="waveSpeed">
        </div>

        <!-- Chaser Control -->
        <div class="card">
            <h2>Channel Chaser</h2>

            <button id="chaserButton" class="button">Start Chaser</button>

            <label for="chaserSpeed">Chaser Speed: <span id="chaserSpeedVal">100</span> ms</label>
            <input type="range" min="10" max="5000" value="100" class="slider" id="chaserSpeed">
        </div>
        
        <!-- Breath Effect Control -->
        <div class="card">
            <h2>Breath Effect</h2>

            <button id="breathButton" class="button">Start Breath</button>

            <label for="breathSpeed">Speed: <span id="breathSpeedVal">5</span></label>
            <input type="range" min="1" max="100" value="5" class="slider" id="breathSpeed">

            <label for="breathMin">Min Brightness: <span id="breathMinVal">10</span></label>
            <input type="range" min="0" max="255" value="10" class="slider" id="breathMin">

            <label for="breathMax">Max Brightness: <span id="breathMaxVal">255</span></label>
            <input type="range" min="0" max="255" value="255" class="slider" id="breathMax">

            <label for="breathChannelsDropdown">Affected Channels:</label>
            <div class="dropdown">
                <div class="dropdown-header" id="breathChannelsDropdown">Select Channels</div>
                <div class="dropdown-list" id="breathDropdownList">
                    <!-- Channels populated dynamically -->
                </div>
            </div>
            <p><button id="breathApply" class="button">Apply Channels</button></p>
        </div>

        <!-- Sliders -->
        <div class="card">
            <h2>DMX channel control 1-24</h2>

            <label for="s1">Channel 1: <span id="val1">0</span></label>
            <input type="range" min="0" max="255" value="0" class="slider" id="s1">

            <label for="s2">Channel 2: <span id="val2">0</span></label>
            <input type="range" min="0" max="255" value="0" class="slider" id="s2">

            <label for="s3">Channel 3: <span id="val3">0</span></label>
            <input type="range" min="0" max="255" value="0" class="slider" id="s3">

            <label for="s4">Channel 4: <span id="val4">0</span></label>
            <input type="range" min="0" max="255" value="0" class="slider" id="s4">

            <label for="s5">Channel 5: <span id="val5">0</span></label>
            <input type="range" min="0" max="255" value="0" class="slider" id="s5">

            <label for="s6">Channel 6: <span id="val6">0</span></label>
            <input type="range" min="0" max="255" value="0" class="slider" id="s6">

            <label for="s7">Channel 7: <span id="val7">0</span></label>
            <input type="range" min="0" max="255" value="0" class="slider" id="s7">
            
            <label for="s8">Channel 8: <span id="val8">0</span></label>
            <input type="range" min="0" max="255" value="0" class="slider" id="s8">

            <label for="s9">Channel 9: <span id="val9">0</span></label>
            <input type="range" min="0" max="255" value="0" class="slider" id="s9">

            <label for="s10">Channel 10: <span id="val10">0</span></label>
            <input type="range" min="0" max="255" value="0" class="slider" id="s10">

            <label for="s11">Channel 11: <span id="val11">0</span></label>
            <input type="range" min="0" max="255" value="0" class="slider" id="s11">

            <label for="s12">Channel 12: <span id="val12">0</span></label>
            <input type="range" min="0" max="255" value="0" class="slider" id="s12">

            <label for="s13">Channel 13: <span id="val13">0</span></label>
            <input type="range" min="0" max="255" value="0" class="slider" id="s13">

            <label for="s14">Channel 14: <span id="val14">0</span></label>
            <input type="range" min="0" max="255" value="0" class="slider" id="s14">

            <label for="s15">Channel 15: <span id="val15">0</span></label>
            <input type="range" min="0" max="255" value="0" class="slider" id="s15">

            <label for="s16">Channel 16: <span id="val16">0</span></label>
            <input type="range" min="0" max="255" value="0" class="slider" id="s16">

            <label for="s17">Channel 17: <span id="val17">0</span></label>
            <input type="range" min="0" max="255" value="0" class="slider" id="s17">

            <label for="s18">Channel 18: <span id="val18">0</span></label>
            <input type="range" min="0" max="255" value="0" class="slider" id="s18">

            <label for="s19">Channel 19: <span id="val19">0</span></label>
            <input type="range" min="0" max="255" value="0" class="slider" id="s19">

            <label for="s20">Channel 20: <span id="val20">0</span></label>
            <input type="range" min="0" max="255" value="0" class="slider" id="s20">

            <label for="s21">Channel 21: <span id="val21">0</span></label>
            <input type="range" min="0" max="255" value="0" class="slider" id="s21">

            <label for="s22">Channel 22: <span id="val22">0</span></label>
            <input type="range" min="0" max="255" value="0" class="slider" id="s22">

            <label for="s23">Channel 23: <span id="val23">0</span></label>
            <input type="range" min="0" max="255" value="0" class="slider" id="s23">

            <label for="s24">Channel 24: <span id="val24">0</span></label>
            <input type="range" min="0" max="255" value="0" class="slider" id="s24">
        </div>

    </div>

    <script>
        var gateway = `ws://${window.location.hostname}/ws`;
        var websocket;

        function initWebSocket() {
            console.log('Trying to open a WebSocket connection...');
            websocket = new WebSocket(gateway);
            websocket.onopen = onOpen;
            websocket.onclose = onClose;
            websocket.onmessage = onMessage;
        }

        function onOpen(event) {
            console.log('Connection opened');
        }

        function onClose(event) {
            console.log('Connection closed');
            setTimeout(initWebSocket, 2000);
        }

        function onMessage(event) {
            const msg = event.data;

            // simple on/off state
            if (msg == "1" || msg == "0") {
                document.getElementById('state').innerHTML = (msg == "1" ? "ON" : "OFF");
                return;
            }
        }

        window.addEventListener('load', onLoad);

        function onLoad(event) {
            initWebSocket();
            initSliders();
        }

        function toggle() {
            websocket.send('toggle');
        }

        function initSliders() {
            for (let i = 1; i <= 24; i++) {
                let slider = document.getElementById('s' + i);
                let output = document.getElementById('val' + i);

                // set initial value
                output.innerHTML = slider.value;

                // update when moved
                slider.addEventListener('input', function () {
                    output.innerHTML = this.value;
                    sendSlider({ target: this });
                });
            }
        }


        function sendSlider(event) {
            let id = event.target.id.substring(1); // get number from s1 â†’ 1
            let value = event.target.value;
            websocket.send(id + ":" + value);
            console.log("Sent -> " + id + ":" + value);
        }

        function initWaveControls() {
            const waveButton = document.getElementById('waveButton');
            const waveSpeedSlider = document.getElementById('waveSpeed');
            const waveSpeedVal = document.getElementById('waveSpeedVal');

            waveButton.addEventListener('click', function() {
                websocket.send('wave:toggle'); // toggle wave on/off
            });

            waveSpeedSlider.addEventListener('input', function() {
                waveSpeedVal.innerHTML = this.value;
                websocket.send('wave:speed:' + this.value); // send new speed
            });
        }

        window.addEventListener('load', function() {
            initWaveControls();
        });

        function initChaserControls() {
            const chaserButton = document.getElementById('chaserButton');
            const chaserSpeedSlider = document.getElementById('chaserSpeed');
            const chaserSpeedVal = document.getElementById('chaserSpeedVal');

            chaserButton.addEventListener('click', function() {
                websocket.send('chaser:toggle'); // toggle chaser
            });

            chaserSpeedSlider.addEventListener('input', function() {
                chaserSpeedVal.innerHTML = this.value;
                websocket.send('chaser:speed:' + this.value); // set speed
            });
        }

        window.addEventListener('load', function() {
            initChaserControls();
        });

        function initBreathControls() {
            const breathButton = document.getElementById('breathButton');
            const speedSlider = document.getElementById('breathSpeed');
            const speedVal = document.getElementById('breathSpeedVal');
            const minSlider = document.getElementById('breathMin');
            const minVal = document.getElementById('breathMinVal');
            const maxSlider = document.getElementById('breathMax');
            const maxVal = document.getElementById('breathMaxVal');
            const applyButton = document.getElementById('breathApply');

            // Modern dropdown
            const dropdownHeader = document.getElementById('breathChannelsDropdown');
            const dropdownList = document.getElementById('breathDropdownList');

            // Populate dropdown with 512 channels
            for (let i = 1; i <= 512; i++) {
                const label = document.createElement('label');
                label.innerHTML = `<input type="checkbox" value="${i}"> Channel ${i}`;
                dropdownList.appendChild(label);
            }

            dropdownHeader.addEventListener('click', () => {
                dropdownList.style.display =
                    dropdownList.style.display === 'block' ? 'none' : 'block';
                dropdownHeader.classList.toggle('active');
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!dropdownHeader.contains(e.target) && !dropdownList.contains(e.target)) {
                    dropdownList.style.display = 'none';
                    dropdownHeader.classList.remove('active');
                }
            });

            breathButton.addEventListener('click', function() {
                websocket.send('breath:toggle');
            });

            speedSlider.addEventListener('input', function() {
                speedVal.innerHTML = this.value;
                websocket.send('breath:speed:' + this.value);
            });

            minSlider.addEventListener('input', function() {
                minVal.innerHTML = this.value;
                websocket.send('breath:min:' + this.value);
            });

            maxSlider.addEventListener('input', function() {
                maxVal.innerHTML = this.value;
                websocket.send('breath:max:' + this.value);
            });

            applyButton.addEventListener('click', function() {
                const selected = Array.from(
                    dropdownList.querySelectorAll('input[type="checkbox"]:checked')
                ).map(cb => cb.value).join(',');
                websocket.send('breath:channels:' + selected);
                console.log('Breath channels set ->', selected);

                // Update dropdown header text
                if (selected.length === 0) {
                    dropdownHeader.textContent = "Select Channels";
                } else {
                    dropdownHeader.textContent = `${selected.split(',').length} selected`;
                }
                dropdownList.style.display = 'none';
                dropdownHeader.classList.remove('active');
            });
        }

        window.addEventListener('load', initBreathControls);


    </script>
</body>

</html>
